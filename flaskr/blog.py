from flask import (
    Blueprint, flash, g, redirect, render_template, request, url_for, make_response
)
from werkzeug.exceptions import abort

from flaskr.auth import login_required
from flaskr.db import get_db
from flaskr.auth import session
from wtforms import Form, StringField, SelectField
from .forms import DateSearchForm
from datetime import date

bp = Blueprint('blog', __name__)

@bp.route('/create', methods=('GET', 'POST'))
def create():
    secret = 'dev'
    db = get_db()
    cursor = db.cursor()
    if request.method == 'POST':

        key = request.form['token']

        if key == 'dev':
            results = []
            total = request.form['amount']
            account = request.form['account']
            user_id = request.args.get('user_id')
            name = g.user[1]
            print(name)
            error = None

            if total is None:
                error = 'Transfer amount is required.'

            if account is None:
                error = 'Account username is required'

            if error is not None:
                flash(error)
            else:
                cursor.execute("SELECT balance FROM accounts WHERE username = %s", [name])
                current_balance_user = cursor.fetchone()
                cursor.execute("SELECT balance FROM accounts WHERE username = %s", [account])
                current_balance_target = cursor.fetchone()

                if current_balance_target is not None:
                    if int(total) <= int(current_balance_user[0]):

                        new_balance_user = int(current_balance_user[0]) - int(total)
                        new_balance_target = int(current_balance_target[0]) + int(total)
                        cursor.execute("UPDATE accounts SET balance = %s WHERE username = %s", (new_balance_target, account))
                        cursor.execute("UPDATE accounts SET balance = %s WHERE username = %s", (new_balance_user, name))
                        db.commit();

                        cursor.execute("SELECT * FROM accounts WHERE username = %s OR username = %s", (name, account))
                        if cursor.rowcount > 0:
                            results = cursor.fetchall()

                        cursor.execute(
                            "INSERT INTO transactions (username, date, amount) VALUES (%s, %s, %s)", 
                            (name, date.today(), total)
                        )
                        db.commit();

                        return render_template('blog/create.html', user_id=user_id, results=results)

    cursor.execute(
        "SELECT * FROM accounts WHERE username LIKE %s", [g.user[1]]
    )
    balance = cursor.fetchone()
    session['balance'] = balance[2]

    user_id = request.args.get('user_id')
    return render_template('blog/create.html', user_id=user_id)


@bp.route('/update', methods=('GET', 'POST'))
def update():
    search = DateSearchForm(request.form)
    if request.method == 'POST':
        return search_results(search)
    user_id = request.args.get('user_id')
    return render_template('blog/update.html', user_id=user_id, form=search)

def search_results(search):
    results = []
    user_id = g.user[0]
    search_string = search.data['search']
    db = get_db()
    cursor = db.cursor()
    name = g.user[1]
    print(name)
    query = "SELECT * FROM transactions WHERE date = '" + search_string + "' AND username = '" + name + "'"
    print(query)
    cursor.execute(query)
    if cursor.rowcount > 0:
        results = cursor.fetchall()

    return render_template('blog/update.html', user_id=user_id, form=search, results=results)

@bp.route('/index', methods=('GET', 'POST'))
def index():
    if request.method == 'POST':
        secretWord = request.form['secretWord']
        user_id = g.user[0]
        db = get_db()
        cursor = db.cursor()
        error = None

        if not secretWord:
            error = 'Secret Word is required.'

        if error is not None:
            flash(error)

        if error is None:
            cursor.execute(
                "UPDATE users SET secretKey = %s WHERE username LIKE %s",
                (secretWord, g.user[1])
            )

            db.commit()
            return redirect(url_for('blog.index',user_id=user_id))

    elif request.method == 'GET':
        user_id = request.args.get('user_id')
        db = get_db()
        cursor = db.cursor()
        cursor.execute(
            "SELECT username FROM stalim WHERE CAST(id as CHAR) LIKE %s", [user_id]
        )
        cursor.execute(
            "SELECT secretKey FROM stalim WHERE CAST(id as CHAR) LIKE %s", [user_id]
        )
        secretKey = cursor.fetchone()
        session['secretWord'] = secretKey

        res = make_response(render_template('blog/index.html',user_id=user_id))
        if g.user is not None:
            res.set_cookie('username', g.user[1], max_age=5)
            res.set_cookie('password', g.user[2], max_age=5)

        return res
